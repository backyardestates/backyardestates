generator client {
    provider   = "prisma-client-js"
    engineType = "binary"
}

datasource db {
    provider = "postgresql"
}

/**
 * =========================
 * EXISTING ENUMS (kept)
 * =========================
 */

enum Role {
    CUSTOMER
    ARCHITECT
    ADMIN
}

enum WorkStatus {
    DRAFT
    ACTIVE
    DEPRECATED
}

enum CalcMethod {
    LINEAR_FT
    SQ_FT
    QUANTITY
    MANUAL
    ALLOWANCE
    UNIT_RATE
}

enum MarkupType {
    PERCENT
    FIXED
    TIERED
    NONE
}

enum ImpactArea {
    PLANS
    PERMITTING
    CONSTRUCTION
    TIMELINE
}

enum Severity {
    LOW
    MEDIUM
    HIGH
}

enum FeasibilityAnswerValue {
    YES
    NO
    UNSURE
}

enum AnalysisStatus {
    PENDING
    IN_PROGRESS
    COMPLETE
}

enum ProposalStatus {
    DRAFT
    REVIEWED
    SENT
    SIGNED
    ARCHIVED
}

enum AssessStage {
    LEAD_STAGE
    OFFICE_VISIT
    FORMAL_ANALYSIS
    PRE_PERMIT
    PRE_CONSTRUCTION
}

/**
 * =========================
 * NEW ENUMS (recommended)
 * =========================
 */

enum ProposalStage {
    LEAD_STAGE
    OFFICE_VISIT
    FORMAL_ANALYSIS
    PRE_PERMIT
    PRE_CONSTRUCTION
}

enum LeadChannel {
    WEBSITE
    INSTAGRAM
    FACEBOOK
    TIKTOK
    YOUTUBE
    GOOGLE
    OPEN_HOUSE
    REFERRAL
    OTHER
}

enum AduType {
    ATTACHED
    DETACHED
}

enum LineItemKind {
    SITE_WORK
    UPGRADE
    CUSTOM
}

enum DiscountType {
    FIXED
    PERCENT
    PROMO
}

enum ProposalEventType {
    CREATED
    UPDATED
    SUBMITTED
    PDF_GENERATION_STARTED
    PDF_GENERATED
    SENT
    VIEWED
    SIGNED
    ARCHIVED
}

enum WorkItemKind {
    SITE_WORK
    UPGRADE
}

/**
 * =========================
 * MULTI-TENANT
 * =========================
 */

model Organization {
    id        String   @id @default(cuid())
    name      String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    memberships Membership[]
    proposals   Proposal[]
}

model Membership {
    id             String @id @default(cuid())
    organizationId String
    userId         String

    organization Organization @relation(fields: [organizationId], references: [id])
    user         User         @relation(fields: [userId], references: [id])

    role Role @default(ADMIN)

    createdAt DateTime @default(now())

    @@unique([organizationId, userId])
    @@index([userId])
    @@index([organizationId])
}

/**
 * =========================
 * CORE USERS
 * =========================
 */

model User {
    id   String @id // Supabase auth user id (uuid as string)
    role Role   @default(CUSTOMER)

    phone String?
    email String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    feasibilityReports FeasibilityReport[]
    formalAnalyses     FormalAnalysis[]    @relation("ArchitectAssignments")
    evidenceFiles      EvidenceFile[]

    proposalsCreated  Proposal[] @relation("ProposalCreatedBy")
    proposalsAssigned Proposal[] @relation("ProposalAssignedTo")

    memberships    Membership[]
    proposalEvents ProposalEvent[]
}

/**
 * =========================
 * WORK ITEM CATALOG (SITE WORK + UPGRADES)
 * =========================
 */

model Category {
    id        String @id @default(cuid())
    name      String @unique
    sortOrder Int    @default(0)

    workItems WorkItem[]
}

model WorkItem {
    id           String     @id @default(cuid())
    slug         String     @unique
    title        String
    overview     String?
    description  String?
    whyItMatters String?
    status       WorkStatus @default(ACTIVE)

    // âœ… NEW: differentiate Site Work vs Upgrade
    kind WorkItemKind @default(SITE_WORK)

    categoryId String
    category   Category @relation(fields: [categoryId], references: [id])

    // Typical CUSTOMER exposure for the feasibility (ranges shown to clients)
    typicalMin Int?
    typicalMax Int?

    // Optional INTERNAL ranges (used later for job cost)
    internalMin Int?
    internalMax Int?

    // flags for easy filtering
    affectsPlans        Boolean @default(false)
    affectsPermitting   Boolean @default(false)
    affectsConstruction Boolean @default(false)

    // Human guidance
    assessmentSummary String?
    avoidanceSummary  String?
    confidenceScore   Int?

    pricingModels PricingModel[]
    impacts       ImpactDetail[]

    triggersFrom TriggerRule[] @relation("TriggersFrom")
    triggersTo   TriggerRule[] @relation("TriggersTo")

    feasibilityAnswers FeasibilityAnswer[]
    formalAnswers      FormalAnswer[]
    evidenceFiles      EvidenceFile[]

    // catalog usage in proposals
    proposalLineItems ProposalLineItem[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([kind, status])
    @@index([categoryId, kind])
}

model PricingModel {
    id         String   @id @default(cuid())
    workItemId String
    workItem   WorkItem @relation(fields: [workItemId], references: [id])

    calcMethod CalcMethod
    unitLabel  String?

    // Optional: you can fill these later for real proposal math
    baseInternal Int?
    baseCustomer Int?
    internalUnit Int?
    customerUnit Int?

    markupType  MarkupType @default(NONE)
    markupValue Float?

    notes     String?
    isDefault Boolean @default(true)
}

model ImpactDetail {
    id         String   @id @default(cuid())
    workItemId String
    workItem   WorkItem @relation(fields: [workItemId], references: [id])

    area     ImpactArea
    severity Severity   @default(MEDIUM)
    detail   String?

    durationMinDays Int?
    durationMaxDays Int?
}

model TriggerRule {
    id                  String @id @default(cuid())
    sourceWorkItemId    String
    triggeredWorkItemId String

    source    WorkItem @relation("TriggersFrom", fields: [sourceWorkItemId], references: [id])
    triggered WorkItem @relation("TriggersTo", fields: [triggeredWorkItemId], references: [id])

    condition   String?
    probability Float?
    notes       String?
}

/**
 * =========================
 * FEASIBILITY / FORMAL ANALYSIS (kept)
 * =========================
 */

model FeasibilityReport {
    id     String @id @default(cuid())
    userId String
    user   User   @relation(fields: [userId], references: [id])

    address    String?
    city       String?
    aduType    String? // detached/attached/jadus/etc (string for now)
    timeframe  String?
    priority   String?
    motivation String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    answers        FeasibilityAnswer[]
    formalAnalyses FormalAnalysis[]
}

model FeasibilityAnswer {
    id       String            @id @default(cuid())
    reportId String
    report   FeasibilityReport @relation(fields: [reportId], references: [id])

    workItemId String
    workItem   WorkItem @relation(fields: [workItemId], references: [id])

    answer FeasibilityAnswerValue

    // freeze what you displayed at time of report
    shownMin Int?
    shownMax Int?

    createdAt DateTime @default(now())

    @@unique([reportId, workItemId])
}

model FormalAnalysis {
    id       String            @id @default(cuid())
    reportId String
    report   FeasibilityReport @relation(fields: [reportId], references: [id])

    architectId String?
    architect   User?   @relation("ArchitectAssignments", fields: [architectId], references: [id])

    status      AnalysisStatus @default(PENDING)
    scheduledAt DateTime?
    startedAt   DateTime?
    completedAt DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    answers  FormalAnswer[]
    files    EvidenceFile[]
    proposal Proposal?
}

model FormalAnswer {
    id               String         @id @default(cuid())
    formalAnalysisId String
    formalAnalysis   FormalAnalysis @relation(fields: [formalAnalysisId], references: [id])

    workItemId String
    workItem   WorkItem @relation(fields: [workItemId], references: [id])

    // flexible payload (store structured answer details)
    valueJson Json?
    notes     String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([formalAnalysisId, workItemId])
}

model EvidenceFile {
    id               String         @id @default(cuid())
    formalAnalysisId String
    formalAnalysis   FormalAnalysis @relation(fields: [formalAnalysisId], references: [id])

    workItemId String?
    workItem   WorkItem? @relation(fields: [workItemId], references: [id])

    storagePath  String // Supabase Storage path
    fileName     String?
    fileType     String?
    uploadedById String?
    uploadedBy   User?   @relation(fields: [uploadedById], references: [id])

    createdAt DateTime @default(now())
}

/**
 * =========================
 * PROPOSALS (NEW: ANALYTICS + SNAPSHOT)
 * =========================
 */

model Proposal {
    id String @id @default(cuid())

    organizationId String
    organization   Organization @relation(fields: [organizationId], references: [id])

    // Optional link to FormalAnalysis
    formalAnalysisId String?         @unique
    formalAnalysis   FormalAnalysis? @relation(fields: [formalAnalysisId], references: [id])

    status ProposalStatus @default(DRAFT)

    // Choose ONE: keep AssessStage OR use ProposalStage (keeping both is OK)
    stage ProposalStage?

    channel LeadChannel?

    createdById String
    createdBy   User   @relation("ProposalCreatedBy", fields: [createdById], references: [id])

    assignedToId String?
    assignedTo   User?   @relation("ProposalAssignedTo", fields: [assignedToId], references: [id])

    // Customer snapshot
    customerName  String
    customerEmail String?
    customerPhone String?

    // Address snapshot (queryable)
    addressLine1 String
    addressLine2 String?
    city         String
    county       String?
    state        String
    zip          String

    // Totals
    totalPrice     Int?
    totalSiteWork  Int?
    totalUpgrades  Int?
    totalDiscounts Int?
    internalTotal  Int?
    profit         Int?

    // Snapshot + versioning
    snapshotVersion Int   @default(1)
    pricingVersion  Int   @default(1)
    snapshotJson    Json?

    // PDF lifecycle
    pdfStatus String?
    pdfUrl    String?

    notes String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    lineItems  ProposalLineItem[]
    floorplans ProposalFloorplanSelection[]
    discounts  ProposalDiscount[]
    outputs    ProposalComputedOutput?
    events     ProposalEvent[]
    uploads    ProposalUpload[]

    @@index([organizationId, createdAt])
    @@index([status, createdAt])
    @@index([city, zip])
    @@index([createdById, createdAt])
    @@index([assignedToId, status])
    @@index([totalPrice])
}

model ProposalFloorplanSelection {
    id         String   @id @default(cuid())
    proposalId String
    proposal   Proposal @relation(fields: [proposalId], references: [id])

    aduType AduType

    // Sanity floorplan document id
    floorplanRef String

    // Snapshotted fields
    name      String?
    sqft      Int?
    bed       Int?
    bath      Int?
    basePrice Int?

    createdAt DateTime @default(now())

    @@index([proposalId])
    @@index([floorplanRef, aduType])
    @@index([sqft])
}

model ProposalLineItem {
    id         String   @id @default(cuid())
    proposalId String
    proposal   Proposal @relation(fields: [proposalId], references: [id])

    kind LineItemKind @default(SITE_WORK)

    // optional catalog reference (null for CUSTOM)
    workItemId String?
    workItem   WorkItem? @relation(fields: [workItemId], references: [id])

    // snapshot fields (catalog edits should not change old proposals)
    title     String
    category  String?
    unitLabel String?
    quantity  Float?

    // internal/private
    internalCost Int?
    markupType   MarkupType @default(NONE)
    markupValue  Float?

    // customer-facing pricing
    unitPrice     Int?
    computedPrice Int?
    overridePrice Int?
    finalPrice    Int?

    // applicability mapping
    appliesTo Json?

    notes String?

    createdAt DateTime @default(now())

    @@index([proposalId])
    @@index([workItemId, kind])
    @@index([category])
}

model ProposalDiscount {
    id         String   @id @default(cuid())
    proposalId String
    proposal   Proposal @relation(fields: [proposalId], references: [id])

    discountType DiscountType

    // optional Sanity discount doc id
    discountRef String?
    name        String?

    amountOff  Int?
    percentOff Float?

    appliesTo Json?

    createdAt DateTime @default(now())

    @@index([proposalId])
    @@index([discountRef])
}

model ProposalComputedOutput {
    id         String   @id @default(cuid())
    proposalId String   @unique
    proposal   Proposal @relation(fields: [proposalId], references: [id])

    rentEstimateMonthly    Int?
    paymentEstimateMonthly Int?
    cashflowMonthly        Int?

    roiYear1  Float?
    roiYear5  Float?
    roiYear10 Float?

    equityBoostYear1  Int?
    equityBoostYear5  Int?
    equityBoostYear10 Int?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([rentEstimateMonthly])
    @@index([cashflowMonthly])
}

model ProposalEvent {
    id         String   @id @default(cuid())
    proposalId String
    proposal   Proposal @relation(fields: [proposalId], references: [id])

    type    ProposalEventType
    actorId String?
    actor   User?             @relation(fields: [actorId], references: [id])

    metadata Json?

    createdAt DateTime @default(now())

    @@index([proposalId, createdAt])
    @@index([type, createdAt])
}

model ProposalUpload {
    id         String   @id @default(cuid())
    proposalId String
    proposal   Proposal @relation(fields: [proposalId], references: [id])

    kind String // e.g. "CAN_I_BUILD_SCREENSHOT"
    url  String

    publicId String?
    width    Int?
    height   Int?

    createdAt DateTime @default(now())

    @@index([proposalId])
}
